#!/bin/bash

SCRIPT_VERSION="1.0"

SELF_NAME="patch-update"
SELF_PRETTY_NAME="AqualinkD Raspberry Pi OS $SELF_NAME (v$SCRIPT_VERSION)"

TRUE=0
FALSE=1

DEBUG=$TRUE

CHECK_SERIAL_BOOT_PARMS=$TRUE
DISABLE_WIFI_POWERSAVE=$TRUE
SET_WIFI_LOCALIZATION=$TRUE
SET_JOURNAL_SIZE=$TRUE


JOURNAL_CFG="/etc/systemd/journald.conf"
WIFI_POWER_CFG="/etc/NetworkManager/conf.d/10-default-wifi-power-save.conf"
PI_BOOT_CFG="/boot/firmware/config.txt"


red=$'\e[31m'
green=$'\e[32m'
reset=$'\e[0m'

_updated=$FALSE

source /etc/os-release
# Should give us the following
# VERSION_ID="11"
# VERSION="11 (bullseye)"
# VERSION_CODENAME=bullseye

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit 1
fi


#####################################
# Functions

# Nicely printed output 
function msg() {
  echo -e "${green}$@${reset}" >&2
}
function msgerr() {
  echo -e "${red}Error: $@${reset}" >&2
}

# simple output 
function log() {
  echo -e "$*" >&2
}
function logdbg() {
  if [ $DEBUG == $TRUE ]; then
    log "$@"
  fi
}

disable_service() {
  local service="$1"

  # Check if it's already masked (returns 'masked' as a string)
  if [[ $(systemctl is-enabled "$service" 2>/dev/null) == "masked" ]]; then
    msg "Service $service is already masked. Skipping."
    return
  fi

  # If it's running or just enabled, kill it and mask it
  if systemctl is-active --quiet "$service" || systemctl is-enabled --quiet "$service" 2>/dev/null; then
    msg "Service $service is active/enabled. Stopping and masking..."
    
    # --now handles the 'stop' and the 'mask' in one go
    sudo systemctl mask --now "$service"
    
    _updated=$TRUE
  else
    msg "Service $service not found or already inactive. Skipping."
  fi
}

check_boot_params() {
    local changed=$FALSE
    
    # 1. Check UART
    if ! grep -q "^[[:space:]]*enable_uart=1" "$PI_BOOT_CFG"; then
        msgerr "Looks like UART is disabled (HAT will not work)"
        # Force reading from the terminal, even if piped from curl
        read -p "Would you like to enable it now? (y/n): " -n 1 -r choice < /dev/tty
        echo "" # Add a newline after the -n 1 char 
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            echo "# AqualinkD enable uart (for RS485 HAT)" | sudo tee -a "$PI_BOOT_CFG" > /dev/null
            echo "enable_uart=1" | sudo tee -a "$PI_BOOT_CFG" > /dev/null
            changed=$TRUE
        fi
    fi

    # 2. Check Bluetooth
    if ! grep -q "^[[:space:]]*dtoverlay=disable-bt" "$PI_BOOT_CFG"; then
        msgerr "Looks like Bluetooth is enabled (Recommended to disable for HAT stability)."
        read -p "Would you like to disable Bluetooth now? (y/n): " -n 1 -r choice < /dev/tty
        echo ""
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            echo "# AqualinkD disable BT (causes problems on CM4)" | sudo tee -a "$PI_BOOT_CFG" > /dev/null
            echo "dtoverlay=disable-bt" | sudo tee -a "$PI_BOOT_CFG" > /dev/null
            changed=$TRUE
        fi
    fi

    if [[ "$changed" -eq "$TRUE" ]]; then
      msg "Changes were made to $PI_BOOT_CFG"
      msg "A reboot is required to apply these changes."
    fi
}

# Set max file size journal logs can use
set_journal_size() {
  if ! grep -q "^SystemMaxUse=200M" $JOURNAL_CFG; then
    msg "Setting max journal to 200M"
    echo "SystemMaxUse=200M" >> $JOURNAL_CFG
    _updated=$TRUE
  else
    logdbg "Journal max size looks good $JOURNAL_CFG"
  fi
}


# turn off wifi powersaving
disable_wifi_powersave()
{
  if [ ! -f "$WIFI_POWER_CFG" ]; then
    msg "Turning off WiFi power saving"
    cat << EOF > "$WIFI_POWER_CFG"
# Turn off WiFi power saving
[connection]
wifi.powersave = 2
EOF
    systemctl restart NetworkManager
    _updated=$TRUE
  else
    setting=$(grep "wifi.powersave" "$WIFI_POWER_CFG" | awk 'BEGIN { FS="=" } { gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2 }')
    if [ ! $setting -eq 2 ]; then
      msg "WiFi power save already exists"
      msg "Please edit '$WIFI_POWER_CFG' and change 'wifi.powersave = $setting' to 'wifi.powersave = 2'"
    else
      logdbg "WiFi power save is set correctly - $WIFI_POWER_CFG"
    fi
  fi

  #sudo systemctl restart NetworkManager
  #sudo iw dev wlan0 get power_save
}


if [[ "$CHECK_SERIAL_BOOT_PARMS" -eq "$TRUE" ]]; then
  check_boot_params
fi

if [[ "$SET_JOURNAL_SIZE" -eq "$TRUE" ]]; then
  set_journal_size
fi

if [[ "$DISABLE_WIFI_POWERSAVE" -eq "$TRUE" ]]; then
  disable_wifi_powersave
fi

disable_service "bluetooth.service"
disable_service "hciuart.service"
disable_service "apt-daily.timer"
disable_service "apt-daily-upgrade.timer"
disable_service "triggerhappy.service"
disable_service "ModemManager.service"
disable_service "cups.service"

if [[ "$_updated" -eq "$TRUE" ]]; then
  msg "System updated"
else
  msg "System looks good, nothing changed!"
fi